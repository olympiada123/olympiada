{% extends 'base.html' %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - –û–ª–∏–º–ø–∏–∞–¥–∞{% endblock %}

{% block content %}
<div class="container">
    <div class="about-page">
        <h1 class="about-page-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>

        <section class="about-section">
            <div class="profile-layout">
                <div class="detail-section-card profile-info-card">
                    <h2 class="section-title">–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                    <div class="profile-info-compact">
                        <div class="profile-info-card-item">
                            <div class="profile-info-content">
                                <span class="profile-info-label">–ò–º—è</span>
                                <span class="profile-info-value">{{ user.first_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</span>
                            </div>
                        </div>
                        <div class="profile-info-card-item">
                            <div class="profile-info-content">
                                <span class="profile-info-label">–§–∞–º–∏–ª–∏—è</span>
                                <span class="profile-info-value">{{ user.last_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–æ" }}</span>
                            </div>
                        </div>
                        <div class="profile-info-card-item">
                            <div class="profile-info-content">
                                <span class="profile-info-label">–†–æ–ª—å</span>
                                <span class="profile-info-value profile-role profile-role-{% if role == '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' %}admin{% elif role == '–ö—É—Ä–∞—Ç–æ—Ä' %}curator{% else %}student{% endif %}">{{ role }}</span>
                            </div>
                        </div>
                        <div class="profile-info-card-item">
                            <div class="profile-info-content">
                                <span class="profile-info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</span>
                                <span class="profile-info-value">{{ user.created_at|date:"d.m.Y" }}</span>
                            </div>
                        </div>
                        <div class="profile-info-actions">
                            <a href="{% url 'settings' %}" class="btn btn-secondary btn-sm">
                                <span class="btn-icon">‚úèÔ∏è</span>
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                            </a>
                        </div>
                    </div>
                </div>

                {% if not user.is_superuser and not user.is_staff %}
                <div class="detail-section-card profile-olympiads-card">
                <h2 class="section-title">–ú–æ–∏ –æ–ª–∏–º–ø–∏–∞–¥—ã</h2>
                {% if registrations %}
                <div class="registrations-list">
                    {% for registration in registrations %}
                    <div class="registration-card">
                        <div class="registration-header">
                            <h3 class="registration-title">
                                <a href="{% url 'olympiad_detail' registration.olympiad.id %}" class="registration-link">
                                    {{ registration.olympiad.name }}
                                </a>
                            </h3>
                        </div>
                        <div class="registration-details">
                            <div class="registration-detail-item">
                                <span class="detail-icon">üìÖ</span>
                                <span class="detail-text">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {{ registration.registered_at|date:"d.m.Y" }}</span>
                            </div>
                            {% if registration.subjects.all %}
                            <div class="registration-detail-item">
                                <span class="detail-icon">üìö</span>
                                <span class="detail-text">–ü—Ä–µ–¥–º–µ—Ç—ã: {% for subject in registration.subjects.all %}{{ subject.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <p class="empty-state-text">–í—ã –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∏ –Ω–∞ –æ–¥–Ω—É –æ–ª–∏–º–ø–∏–∞–¥—É.</p>
                    <a href="{% url 'olympiads' %}" class="btn btn-primary">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–ª–∏–º–ø–∏–∞–¥—ã</a>
                </div>
                {% endif %}
                </div>
                {% endif %}

                {% if user.is_staff and not user.is_superuser %}
                <div class="detail-section-card profile-olympiads-card">
                    <h2 class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ª–∏–º–ø–∏–∞–¥–∞–º–∏</h2>
                    <div class="curator-actions">
                        <a href="{% url 'create_olympiad' %}" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –æ–ª–∏–º–ø–∏–∞–¥—É</a>
                    </div>
                    
                    <div class="curator-olympiads-filters" style="margin-top: 2rem;">
                        <form method="get" class="curator-search-form">
                            {% if request.GET.user_search %}
                            <input type="hidden" name="user_search" value="{{ request.GET.user_search }}">
                            {% endif %}
                            {% if request.GET.status_filter %}
                            <input type="hidden" name="status_filter" value="{{ request.GET.status_filter }}">
                            {% endif %}
                            <div class="curator-search-wrapper">
                                <input 
                                    type="text" 
                                    name="curator_search" 
                                    class="curator-search-input" 
                                    placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..."
                                    value="{{ curator_search|default:'' }}"
                                >
                                <button type="submit" class="curator-search-btn">–ù–∞–π—Ç–∏</button>
                            </div>
                            <div class="curator-filter-wrapper" style="margin-top: 1rem;">
                                <select name="curator_status_filter" class="curator-status-filter" onchange="this.form.submit()">
                                    <option value="all" {% if curator_status_filter == 'all' or not curator_status_filter %}selected{% endif %}>–í—Å–µ –æ–ª–∏–º–ø–∏–∞–¥—ã</option>
                                    <option value="active" {% if curator_status_filter == 'active' %}selected{% endif %}>–¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–µ</option>
                                    <option value="inactive" {% if curator_status_filter == 'inactive' %}selected{% endif %}>–¢–æ–ª—å–∫–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    
                    {% if curator_olympiads %}
                    <div class="curator-olympiads-list">
                        {% regroup curator_olympiads by is_active as olympiads_by_status %}
                        {% for group in olympiads_by_status %}
                            <h3 class="section-subtitle" style="margin-top: 2rem; margin-bottom: 1rem;">
                                {% if group.grouper %}
                                    –¢–µ–∫—É—â–∏–µ –æ–ª–∏–º–ø–∏–∞–¥—ã
                                {% else %}
                                    –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –æ–ª–∏–º–ø–∏–∞–¥—ã
                                {% endif %}
                            </h3>
                            {% for olympiad in group.list %}
                            <div class="curator-olympiad-item">
                                <div class="curator-olympiad-info">
                                    <h4 class="curator-olympiad-title">
                                        <a href="{% url 'olympiad_detail' olympiad.id %}" class="curator-olympiad-link">
                                            {{ olympiad.name }}
                                        </a>
                                    </h4>
                                    <div class="curator-olympiad-details">
                                        <span class="curator-olympiad-date">–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è: {{ olympiad.start_date|date:"d.m.Y" }} - {{ olympiad.end_date|date:"d.m.Y" }}</span>
                                        <span class="curator-olympiad-registration">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: {{ olympiad.registration_start|date:"d.m.Y" }} - {{ olympiad.registration_end|date:"d.m.Y" }}</span>
                                    </div>
                                </div>
                                <div class="curator-olympiad-actions">
                                    <a href="{% url 'edit_olympiad' olympiad.id %}" class="btn btn-secondary btn-sm">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                                </div>
                            </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state" style="margin-top: 2rem;">
                        <p class="empty-state-text">–û–ª–∏–º–ø–∏–∞–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if user.is_superuser %}
                <div class="detail-section-card profile-olympiads-card">
                    <h2 class="section-title">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</h2>
                    <div class="users-role-management">
                        <form method="get" class="user-search-form">
                            <div class="user-search-wrapper">
                                <input 
                                    type="text" 
                                    name="user_search" 
                                    class="user-search-input" 
                                    placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ñ–∞–º–∏–ª–∏–∏, –ª–æ–≥–∏–Ω—É –∏–ª–∏ email..."
                                    value="{{ search_query|default:'' }}"
                                >
                                <button type="submit" class="btn btn-primary user-search-btn">–ü–æ–∏—Å–∫</button>
                            </div>
                        </form>
                        
                        {% if search_query %}
                        <div class="users-list">
                            {% if all_users %}
                                {% for target_user in all_users %}
                                <div class="user-role-item">
                                    <div class="user-role-info">
                                        <div class="user-role-name">
                                            <strong>{{ target_user.get_full_name|default:target_user.username }}</strong>
                                            <span class="user-role-username">({{ target_user.username }})</span>
                                        </div>
                                        <div class="user-role-current">
                                            <span class="profile-role profile-role-{% if target_user.is_superuser %}admin{% elif target_user.is_staff %}curator{% else %}student{% endif %}">
                                                {% if target_user.is_superuser %}–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä{% elif target_user.is_staff %}–ö—É—Ä–∞—Ç–æ—Ä{% else %}–°—Ç—É–¥–µ–Ω—Ç{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    <form method="post" class="user-role-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="user_id" value="{{ target_user.id }}">
                                        <select name="role" class="role-select" onchange="this.form.submit()">
                                            <option value="student" {% if not target_user.is_superuser and not target_user.is_staff %}selected{% endif %}>–°—Ç—É–¥–µ–Ω—Ç</option>
                                            <option value="curator" {% if target_user.is_staff and not target_user.is_superuser %}selected{% endif %}>–ö—É—Ä–∞—Ç–æ—Ä</option>
                                            <option value="admin" {% if target_user.is_superuser %}selected{% endif %}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                                        </select>
                                    </form>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state">
                                    <p class="empty-state-text">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
                                </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="user-search-hint">
                            <p class="empty-state-text">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </section>

        {% if user.is_superuser and contact_forms is not None %}
        <section class="about-section">
            <div class="detail-section-card">
                <h2 class="section-title">–§–æ—Ä–º—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏</h2>
                <div class="contact-forms-management">
                    <div class="contact-forms-filters">
                        <select name="status_filter" class="status-filter-select" id="contactFormStatusFilter">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="not_processed" {% if status_filter == 'not_processed' %}selected{% endif %}>–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞</option>
                            <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                            <option value="reviewed" {% if status_filter == 'reviewed' %}selected{% endif %}>–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∞</option>
                        </select>
                    </div>
                    
                    <div class="contact-forms-list" id="contactFormsList">
                        {% if contact_forms %}
                            {% for form in contact_forms %}
                            <div class="contact-form-item" data-status="{{ form.status }}" data-form-id="{{ form.id }}">
                                <div class="contact-form-item-header">
                                    <div class="contact-form-item-info">
                                        <h3 class="contact-form-item-subject">{{ form.subject }}</h3>
                                        <div class="contact-form-item-meta">
                                            <span class="contact-form-item-name">{{ form.name }}</span>
                                            <span class="contact-form-item-email">{{ form.email }}</span>
                                        </div>
                                    </div>
                                    <div class="contact-form-item-status">
                                        <span class="contact-form-status contact-form-status-{{ form.status }}">
                                            {{ form.get_status_display }}
                                        </span>
                                    </div>
                                </div>
                                <div class="contact-form-item-dates">
                                    <span class="contact-form-date">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {{ form.created_at|date:"d.m.Y H:i" }}</span>
                                    <span class="contact-form-date">–ò–∑–º–µ–Ω–µ–Ω–æ: {{ form.updated_at|date:"d.m.Y H:i" }}</span>
                                    {% if form.status == 'reviewed' %}
                                    <span class="contact-form-date">–ó–∞–≤–µ—Ä—à–µ–Ω–æ: {{ form.updated_at|date:"d.m.Y H:i" }}</span>
                                    {% endif %}
                                </div>
                                <button 
                                    type="button" 
                                    class="btn btn-secondary btn-sm view-contact-form-btn" 
                                    data-form-id="{{ form.id }}"
                                    data-form-name="{{ form.name }}"
                                    data-form-email="{{ form.email }}"
                                    data-form-subject="{{ form.subject }}"
                                    data-form-message="{{ form.message }}"
                                    data-form-status="{{ form.status }}"
                                    data-form-created="{{ form.created_at|date:'d.m.Y H:i' }}"
                                    data-form-updated="{{ form.updated_at|date:'d.m.Y H:i' }}"
                                >
                                    –ü—Ä–æ—Å–º–æ—Ç—Ä
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <p class="empty-state-text">–§–æ—Ä–º—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
        {% endif %}
    </div>
</div>

{% if user.is_superuser %}
<div id="contactFormModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">–î–µ—Ç–∞–ª–∏ —Ñ–æ—Ä–º—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏</h2>
            <button type="button" class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
        </div>
        <div class="modal-body">
            <div class="contact-form-details">
                <div class="contact-form-detail-item">
                    <span class="contact-form-detail-label">–ò–º—è:</span>
                    <span class="contact-form-detail-value" id="modal-form-name"></span>
                </div>
                <div class="contact-form-detail-item">
                    <span class="contact-form-detail-label">Email:</span>
                    <span class="contact-form-detail-value" id="modal-form-email"></span>
                </div>
                <div class="contact-form-detail-item">
                    <span class="contact-form-detail-label">–¢–µ–º–∞:</span>
                    <span class="contact-form-detail-value" id="modal-form-subject"></span>
                </div>
                <div class="contact-form-detail-item">
                    <span class="contact-form-detail-label">–°–æ–æ–±—â–µ–Ω–∏–µ:</span>
                    <div class="contact-form-detail-message" id="modal-form-message"></div>
                </div>
                <div class="contact-form-detail-item">
                    <span class="contact-form-detail-label">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</span>
                    <span class="contact-form-detail-value" id="modal-form-created"></span>
                </div>
                <div class="contact-form-detail-item">
                    <span class="contact-form-detail-label">–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:</span>
                    <span class="contact-form-detail-value" id="modal-form-updated"></span>
                </div>
                <div class="contact-form-detail-item" id="modal-form-completed" style="display: none;">
                    <span class="contact-form-detail-label">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:</span>
                    <span class="contact-form-detail-value" id="modal-form-completed-date"></span>
                </div>
            </div>
            <div class="contact-form-status-change">
                <form method="post" id="contactFormStatusForm" action="{% url 'profile' %}{% if status_filter %}?status_filter={{ status_filter }}{% endif %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_contact_form_status">
                    <input type="hidden" name="form_id" id="modal-form-id">
                    <div class="form-group">
                        <label for="modal-status-select" class="form-label">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å:</label>
                        <select name="status" id="modal-status-select" class="form-control">
                            <option value="not_processed">–ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞</option>
                            <option value="in_progress">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                            <option value="reviewed">–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∞</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                        <button type="button" class="btn btn-secondary modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if user.is_superuser %}
{% load static %}
<script src="{% static 'js/contact-forms-modal.js' %}"></script>
{% endif %}
{% endblock %}

